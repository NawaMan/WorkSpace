# Full test matrix: Linux, Windows, macOS (amd64 + arm64).
# Triggers on: manual dispatch only (expensive to run).
name: Full Matrix (Manual) - Build and Test

on:
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.platform }} / ${{ matrix.arch }}
    runs-on: ${{ matrix.runs_on }}

    # Linux+Windows ARM64 hosted runners are only available (free) on PUBLIC repos.
    # Skip those entries automatically on private repos to avoid hard failures.
    if: >-
      ${{
        !(
          github.event.repository.private &&
          (matrix.runs_on == 'ubuntu-24.04-arm' || matrix.runs_on == 'windows-11-arm')
        )
      }}

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux
            arch: amd64
            runs_on: ubuntu-latest
          - platform: linux
            arch: arm64
            runs_on: ubuntu-24.04-arm

          # Windows
          - platform: windows
            arch: amd64
            runs_on: windows-latest
          - platform: windows
            arch: arm64
            runs_on: windows-11-arm

          # macOS
          - platform: macos
            arch: amd64
            runs_on: macos-15-intel
          - platform: macos
            arch: arm64
            runs_on: macos-15

    env:
      DOCKER_BUILDKIT: "1"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'

      # Docker is already up on GitHub-hosted Linux/Windows runners in most cases,
      # but macOS often needs setup. This action works on Linux/macOS/Windows.
      - name: Ensure Docker is available
        uses: docker/setup-docker-action@v4

      - name: Verify Docker
        run: |
          docker --version
          docker info

      - name: Build
        run: ./cli-build.sh

      - name: Simple test
        run: ./sanity-test.sh

      - name: Go Unit tests
        run: cd tests/unit && ./run-go-unit-tests.sh

      - name: Go Integration tests
        run: cd tests/unit && ./run-go-integration-tests.sh

      - name: Basic tests
        run: cd tests/basic && ./run-basic-tests.sh

      - name: DryRun tests
        run: cd tests/dryrun && ./run-dryrun-tests.sh

      - name: WorkSpace Env
        run: cd tests/workspace-env && ./run-test.sh
