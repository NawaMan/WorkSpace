# Full test matrix: Linux, Windows, macOS (amd64 + arm64).
# Triggers on: manual dispatch only (expensive to run).
name: Full Matrix (Manual) - Build and Test

on:
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.platform }} / ${{ matrix.arch }}
    runs-on: ${{ matrix.runs_on }}

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux
            arch: amd64
            runs_on: ubuntu-latest
          - platform: linux
            arch: arm64
            runs_on: ubuntu-24.04-arm

          # Windows
          - platform: windows
            arch: amd64
            runs_on: windows-latest
          - platform: windows
            arch: arm64
            runs_on: windows-11-arm

          # macOS
          - platform: macos
            arch: amd64
            runs_on: macos-15-intel
          - platform: macos
            arch: arm64
            runs_on: macos-15

    env:
      DOCKER_BUILDKIT: "1"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'

      # Docker setup: Linux has Docker pre-installed, Windows has Docker available,
      # but macOS GitHub runners don't support the QEMU virtualization needed by Lima/Docker.
      # We skip Docker-dependent tests on macOS.
      - name: Ensure Docker is available (Linux only)
        if: matrix.platform == 'linux'
        run: |
          docker --version
          docker info

      - name: Build
        run: ./cli-build.sh

      - name: Simple test (Docker)
        if: matrix.platform == 'linux'
        run: ./sanity-test.sh

      - name: Go Unit tests
        run: cd tests/unit && ./run-go-unit-tests.sh

      # Docker-dependent tests: only run on Linux where Docker is available
      - name: Go Integration tests (Docker)
        if: matrix.platform == 'linux'
        run: cd tests/unit && ./run-go-integration-tests.sh

      - name: Basic tests (Docker)
        if: matrix.platform == 'linux'
        run: cd tests/basic && ./run-basic-tests.sh

      - name: DryRun tests (Docker)
        if: matrix.platform == 'linux'
        run: cd tests/dryrun && ./run-dryrun-tests.sh

      - name: WorkSpace Env (Docker)
        if: matrix.platform == 'linux'
        run: cd tests/workspace-env && ./run-test.sh
